{"version":3,"sources":["../../../../../../../../assets/scripts/app/game/view/DismissRoom/assets/scripts/app/game/view/DismissRoom/DismissRoomView.js"],"names":["BaseView","require","cc","Class","extends","properties","onLoad","timeProgress","find","txtTime","eventMgr","addEvent","on_room_close_affirm","ret","type","playerName","gameMgr","getPlayerInfoByUID","uid","name","common","showMsgBox","msg","hide","curJushu","okCb","backToLobbyScene","updatePlayer","agree","data","player","getPlayer","setData","string","launch_uid","sec","getCurTime","launch_time","log","timeOffset","timeInterval","getComponent","ProgressBar","progress","bind","director","getScheduler","schedule","personList","clone","_otherPlayerDatas","push","_myData","isRoomOwner","_roomOwnerData","i","node","active","length","user_base_info","agree_list","gUserData","netMgr","request","exec","disagree","_super","clearTimeInterval","unschedule","onDestroy","removeEvent","show","onDisable"],"mappings":"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","file":"DismissRoomView.js","sourceRoot":"../../../../../../../../assets/scripts/app/game/view/DismissRoom","sourcesContent":["var BaseView = require(\"BaseView\")\ncc.Class({\n    extends: BaseView,\n\n    properties: {\n\n    },\n\n    onLoad: function () {\n        this.timeProgress = this.find(\"timeProgress\")\n        this.txtTime = this.find(\"txtTime\")\n        cc.eventMgr.addEvent(\"on_room_close_affirm\", this.on_room_close_affirm, this)\n    },\n\n    on_room_close_affirm: function (ret) {\n        //有人不同意\n        if (3 == ret.type) {\n            var playerName = cc.gameMgr.getPlayerInfoByUID(ret.uid).name\n            cc.common.showMsgBox({ type: 1, msg: playerName + \"拒绝解散房间，本次投票无效\" })\n            this.hide()\n        }\n        //全部人同意解散房间\n        else if (2 == ret.type) {\n            //如果没打完一局全部玩家同意解散则直接解散房间，否则需要弹总结算界面\n            if (cc.gameMgr.curJushu <= 1) {\n                cc.common.showMsgBox({\n                    type: 2, msg: \"解散房间成功\", okCb: function () {\n                        cc.gameMgr.backToLobbyScene()\n                    }\n                })\n                //cc.gameMgr.backToLobbyScene()\n            }\n            else {\n                cc.common.showMsgBox({\n                    type: 2, msg: \"解散房间成功\", okCb: function () {\n\n                    }\n                })\n            }\n        }\n        else if (1 == ret.type) {\n            this.updatePlayer({ uid: ret.uid, agree: ret.type })\n        }\n    },\n\n    //data: {uid, agree}\n    updatePlayer: function (data) {\n        var player = this.getPlayer(data.uid)\n        player.setData(data)\n    },\n\n    setData: function (data) {\n        this.find(\"txtWho\").string = cc.gameMgr.getPlayerInfoByUID(data.launch_uid).name + \" 申请解散房间，请等待其他玩家确认（超时未操作，视为同意）\"\n        var sec = 60 - (getCurTime() - data.launch_time)\n        cc.log(getCurTime(), data.launch_time, sec, timeOffset)\n        if (null == this.timeInterval) {\n            this.timeInterval = function () {\n                if (sec < 0) {\n                    this.hide()\n                    return\n                }\n                this.timeProgress.getComponent(cc.ProgressBar).progress = sec / 60\n                this.txtTime.string = sec\n                sec -= 1\n            }.bind(this)\n\n            cc.director.getScheduler().schedule(this.timeInterval, this, 1);\n        }\n        var personList = clone(cc.gameMgr._otherPlayerDatas)\n        personList.push(clone(cc.gameMgr._myData))\n        if (!cc.gameMgr.isRoomOwner()) {\n            personList.push(clone(cc.gameMgr._roomOwnerData))\n        }\n        this.personList = personList\n\n        for (var i = 0; i < 10; i++) {\n            this.find(\"player\" + (i + 1)).node.active = false\n        }\n        for (var i = 0; i < personList.length; i++) {\n            this.find(\"player\" + (i + 1)).setData({ uid: personList[i].user_base_info.uid, agree: 0 })\n        }\n\n        for (var i = 0; i < data.agree_list.length; i++) {\n            var player = this.getPlayer(data.agree_list[i].uid)\n            player.setData(data.agree_list[i])\n            //如果是本人发起的请求解散房间，隐藏掉 同意拒绝按钮\n            if (data.agree_list[i].uid == gUserData.uid && 1 == data.agree_list[i].agree) {\n                this.find(\"btn_agree\").active = false\n                this.find(\"btn_refuse\").active = false\n            }\n        }\n\n    },\n\n    getPlayer: function (uid) {\n        for (var i = 0; i < this.personList.length; i++) {\n            var player = this.find(\"player\" + (i + 1))\n            if (uid == player.data.uid) {\n                return player\n            }\n        }\n    },\n\n    agree: function () {\n        this.find(\"btn_agree\").active = false\n        this.find(\"btn_refuse\").active = false\n        cc.netMgr.request(\"room_close_affirm\", { agree: 1 }, function (ret) {\n            cc.netMgr.exec(ret, function () {\n            })\n        })\n    },\n\n    disagree: function () {\n        this.find(\"btn_agree\").active = false\n        this.find(\"btn_refuse\").active = false\n        cc.netMgr.request(\"room_close_affirm\", { agree: 0 }, function (ret) {\n            cc.netMgr.exec(ret, function () {\n            })\n        })\n    },\n\n    hide: function () {\n        this._super()\n        this.clearTimeInterval()\n    },\n\n    clearTimeInterval: function () {\n        if (this.timeInterval) {\n            // clearInterval(this.timeInterval)\n            cc.director.getScheduler().unschedule(this.timeInterval, this)\n            this.timeInterval = null\n        }\n    },\n\n    onDestroy: function () {\n        this._super()\n        this.clearTimeInterval()\n        cc.eventMgr.removeEvent(\"on_room_close_affirm\", this.on_room_close_affirm)\n    },\n\n    show: function () {\n        this._super()\n        this.find(\"btn_agree\").active = true\n        this.find(\"btn_refuse\").active = true\n    },\n\n    onDisable: function () {\n        this.timeProgress.getComponent(cc.ProgressBar).progress = 1\n        this.txtTime.string = 60\n    }\n});\n"]}